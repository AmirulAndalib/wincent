# Incorporate /usr/share/X11/locale/en_US.UTF-8/Compose by reference
include "%L"

# This file hacks together macOS-like dead-key support for characters commonly
# typed in Spanish:
#
# - Á, É, Í, Ó, Ú, Ü, Ñ
# - á, é, í, ó, ú, ü, ñ
#
# You might think that something like the following could be used but, sadly, X
# ignores the `Meta` modifier here and simply treats _all_ presses of the `n`
# key as dead-key presses, which means that you can't type a naked `n` any more.
#
#     !Meta <n> <space>  : "~" U007E # TILDE
#     !Meta <n> <N>      : "Ñ" U00D1 # LATIN CAPITAL LETTER N WITH TILDE
#     !Meta <n> <n>      : "ñ" U00F1 # LATIN SMALL LETTER N WITH TILDE
#
# There is evidence that others have seen the same behavior:
#
#     https://unix.stackexchange.com/questions/207067/modifier-keys-in-compose-sequence
#
# This page suggest that this omission may be intentional, even though the
# modifiers are documented in the man page:
#
# > Some keysyms, such as keysyms for modifier keys, are ignored - they have no
# > effect on the status or otherwise.
#
#     https://xkbcommon.org/doc/current/group__compose.html
#
# You might then think about making this work by defining every other possible
# combination of keypresses so that `n` can come out as long as not followed by
# an `n`.
#
#     <n> <a> : "na"
#     <n> <b> : "nb"
#     etc...
#
# Even if that worked (it doesn't, because then you can't type `nn`), you're
# still left with the problem that things that require an immediate response
# (like `n` in Vim) don't work any more.

# Ideally, we'd be able to use Interception Tools to map as follows:
#
# - Left-Meta-n to <dead_tilde>
# - Left-Meta-e to <dead_acute>
# - Left-Meta-u to <dead_diaeresis>
#
# and then use those "dead" keysyms in here to do what we want.
#
# But we have a mismatch between the above (defined in
# /usr/include/X11/keysymdef.h), and the the kernel-level keycodes
# defined in /usr/include/linux/input-event-codes.h, which don't have
# any of the X-specific stuff. There is substantial overlap with
# /usr/include/xkbcommon/xkbcommon-keysyms.h, but that doesn't help us much
# here.
#
# So here is where we finally end up: we use Interception Tools to map to
# function keys F21, F22, and F23 instead. The final fly in the ointment is that
# even though the right keycodes are being sent (and `evtest` confirms this),
# XCompose (and also `xev`) aren't seeing those function keys; they see some
# different keycodes instead. Beggars can't be choosers though, so we just use
# the wrong keysym names in here and everything works.
#
# `xev` sees F21 as keycode = 199, keysym = 0x1008ffa9 (XF86TouchpadToggle)
<XF86TouchpadToggle> <space>  : "~" U007E # TILDE
<XF86TouchpadToggle> <N>      : "Ñ" U00D1 # LATIN CAPITAL LETTER N WITH TILDE
<XF86TouchpadToggle> <n>      : "ñ" U00F1 # LATIN SMALL LETTER N WITH TILDE

# `xev` sees F22 as keycode = 200, keysym = 0x1008ffb0 (XF86TouchpadOn)
<XF86TouchpadOn> <space>  : "´" U0301 # COMBINING ACUTE ACCENT

# Could to more, but sticking to vowels as that's all that are used in Spanish.
<XF86TouchpadOn> <A>      : "Á" U00C1 # LATIN CAPITAL LETTER A WITH ACUTE
<XF86TouchpadOn> <a>      : "á" U00E1 # LATIN SMALL LETTER A WITH ACUTE
<XF86TouchpadOn> <E>      : "É" U00C9 # LATIN CAPITAL LETTER E WITH ACUTE
<XF86TouchpadOn> <e>      : "é" U00E9 # LATIN SMALL LETTER E WITH ACUTE
<XF86TouchpadOn> <I>      : "Í" U00CD # LATIN CAPITAL LETTER I WITH ACUTE
<XF86TouchpadOn> <i>      : "í" U00ED # LATIN SMALL LETTER I WITH ACUTE
<XF86TouchpadOn> <O>      : "Ó" U00D3 # LATIN CAPITAL LETTER O WITH ACUTE
<XF86TouchpadOn> <o>      : "ó" U00F3 # LATIN SMALL LETTER O WITH ACUTE
<XF86TouchpadOn> <U>      : "Ú" U00DA # LATIN CAPITAL LETTER U WITH ACUTE
<XF86TouchpadOn> <u>      : "ú" U00FA # LATIN SMALL LETTER U WITH ACUTE

# `xev` sees F23 as keycode = 201, keysym = 0x1008ffb1 (XF86TouchpadOff)
<XF86TouchpadOff> <space> : "¨" U0308 # COMBINING DIAERESIS
<XF86TouchpadOff> <U>     : "Ü" U00DC # LATIN CAPITAL LETTER U WITH DIAERESIS
<XF86TouchpadOff> <u>     : "ü" U00FC # LATIN SMALL LETTER U WITH DIAERESIS

# Bonus: you never need these in Spanish, but we may as well define them seeing
# as we've rendered `<XF86TouchpadOff>` useless for any other purpose. Still
# only bothering with vowels though.
<XF86TouchpadOff> <A>     : "Ä" U00C4 # LATIN CAPITAL LETTER A WITH DIAERESIS
<XF86TouchpadOff> <a>     : "ä" U00E4 # LATIN SMALL LETTER A WITH DIAERESIS
<XF86TouchpadOff> <E>     : "Ë" U00CB # LATIN CAPITAL LETTER E WITH DIAERESIS
<XF86TouchpadOff> <e>     : "ë" U00EB # LATIN SMALL LETTER E WITH DIAERESIS
<XF86TouchpadOff> <I>     : "Ï" U00CF # LATIN CAPITAL LETTER I WITH DIAERESIS
<XF86TouchpadOff> <i>     : "ï" U00EF # LATIN SMALL LETTER I WITH DIAERESIS
<XF86TouchpadOff> <O>     : "Ö" U00D6 # LATIN CAPITAL LETTER O WITH DIAERESIS
<XF86TouchpadOff> <o>     : "ö" U00F6 # LATIN SMALL LETTER O WITH DIAERESIS

# Ideally, we'd have a bunch of other dead-key equivalents to what we have on
# macOS for typing things that I need semi-regularly (like € and so on), but
# I'll probably need to find a better way of doing things before I expand this
# too much. For now, starting with the basics that I need to be able to write
# Spanish.
