#!/usr/bin/env ruby

require 'io/wait'
require 'pathname'

if $stdin.isatty
  # We're in an interactive shell; just wrap `less`, no questions asked.
  exec 'less', *ARGV
end

# Otherwise, we're being piped to.

$stdin.wait

if $stdin.nread.zero?
  # Not going to pass any `--pattern` arg to `less`.
  ARGV.delete_if { |arg| arg =~ /^--pattern/ || arg == '+r' }

  exec 'less', *ARGV
end

# Nasty hack. Make sure last search pattern is the one we want.
histfile = Pathname.new(ENV.fetch('LESSHISTFILE', '~/.lesshst')).expand_path
if histfile.exist?
  File.open(histfile, 'a') do |f|
    f.puts '"^(commit|diff)'
    f.puts '.search'
  end
end

pipe_read, pipe_write = IO.pipe

child = fork do
  # In child.
  pipe_write.close

  $stdin.reopen(pipe_read)

  exec 'less', *ARGV
end

# In parent.
pipe_read.close

BUF_SIZE = 128

begin
  while !$stdin.eof?
    pipe_write.write $stdin.readpartial(BUF_SIZE)
  end
rescue Errno::EPIPE
  # User probably ran "q" command in `less`.
end

pipe_write.close

Process.wait child
