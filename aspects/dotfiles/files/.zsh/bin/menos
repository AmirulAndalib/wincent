#!/usr/bin/env ruby

require 'pathname'

if $stdin.isatty
  # We're in an interactive shell; just wrap `less`, no questions asked.
  exec 'less', *ARGV
end

# Otherwise, we're being piped to. Try to read enough lines to fill screen.
lines = [`tput lines`.chomp.to_i, 50].min

buffer = []

while buffer.length <= lines
  line = $stdin.gets

  if line.nil?
    # Not enough lines to fill screen; don't pass `--pattern` or `+r`.
    ARGV.delete_if { |arg| arg =~ /^--pattern/ || arg == '+r' }
    break
  else
    buffer.push line
  end
end

# Nasty hack. Make sure last search pattern is the one we want.
histfile = Pathname.new(ENV.fetch('LESSHISTFILE', '~/.lesshst')).expand_path
if histfile.exist?
  File.open(histfile, 'a') do |f|
    f.puts '"^(commit|diff)'
    f.puts '.search'
  end
end

pipe_read, pipe_write = IO.pipe

child = fork do
  # In child.
  pipe_write.close

  $stdin.reopen(pipe_read)

  exec 'less', *ARGV
end

# In parent.
pipe_read.close

BUF_SIZE = 128

# Forward SIGINT to child because `less` handles CTRL-C specially
# depending on whether -K is passed.
Signal.trap('INT') do |signo|
  Process.kill('INT', child)
end

begin
  buffer.each { |line| pipe_write.puts line }

  while !$stdin.eof?
    pipe_write.write $stdin.readpartial(BUF_SIZE)
  end
rescue Errno::EPIPE
  # User probably ran "q" command in `less`.
rescue Interrupt
  exit 130
end

pipe_write.close

Process.wait child
