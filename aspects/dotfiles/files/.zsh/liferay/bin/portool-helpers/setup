#!/bin/bash

# "Installs" a copy of liferay-portal config files.

set -e

PROPERTIES="${BASH_SOURCE%/*}/properties"
BUNDLES="$HOME/code/portal/bundles"
PORTAL="$HOME/code/portal/liferay-portal"
MASTER="$HOME/code/portal-master/liferay-portal"

mkdir -p "$BUNDLES" "$PORTAL"

template() {
  SOURCE=$1; shift
  DEST=$1; shift

  FILTER=''

  while(($#)) ; do
    PATTERN=$1; shift
    REPLACEMENT=$1; shift
    FILTER+="s/$PATTERN/$REPLACEMENT/;"
  done

  cat <(echo "# vim: set nomodifiable : edit $SOURCE instead then run \`portool setup\`, or use \`:set modifiable\` to force."; echo) <(sed -e "$FILTER" "$SOURCE") > "$DEST"
}

VARS=(
  __DB__ lportal_master
  __GOGOSHELL_PORT__ 11311
)

template \
  "$PROPERTIES/portal-ext.properties.dev" \
  "$BUNDLES/portal-ext.properties.dev" \
  "${VARS[@]}"

template \
  "$PROPERTIES/portal-ext.properties.prod" \
  "$BUNDLES/portal-ext.properties.prod" \
  "${VARS[@]}"

ln -sf "$BUNDLES/portal-ext.properties.dev" "$BUNDLES/portal-ext.properties"

VARS=(
  __DB__ lportal_bundle
  __GOGOSHELL_PORT__ 11311
)

template \
  "$PROPERTIES/portal-ext.properties.prod" \
  "$BUNDLES/portal-ext.properties.bundle" \
  "${VARS[@]}"

template "$PROPERTIES/app.server.properties" "$PORTAL/app.server.$USER.properties"
template "$PROPERTIES/app.server.properties" "$MASTER/app.server.$USER.properties"

template "$PROPERTIES/build.properties" "$PORTAL/build.$USER.properties"
template "$PROPERTIES/build.properties" "$MASTER/build.$USER.properties"

